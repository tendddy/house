package com.cninsure.payment.controller.manager;

import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import com.cninsure.core.exception.ControllerException;
import com.cninsure.core.utils.BeanUtils;
import com.cninsure.core.utils.StringUtil;
import com.cninsure.payment.entity.PMBanks;
import com.cninsure.payment.service.PMBanksService;
import com.common.PagingParams;

@Controller
@RequestMapping("/banks/*")
public class BankController {
	@Resource
	private PMBanksService pmbanksService;
	@Autowired
	private HttpServletRequest request;

	/**
	 * 跳转到总银行配置页面
	 * @return
	 * @throws ControllerException
	 */
	@RequestMapping(value="list",method=RequestMethod.GET)
	public ModelAndView showPolicyTongJi()throws ControllerException{
		ModelAndView mav = new ModelAndView("payment/banksconfig");
		return mav;
	}
	
	/**
	 * 跳转到新增或者修改页面
	 * @param id
	 * @return
	 * @throws ControllerException
	 */
	@RequestMapping(value = "addbanks", method = RequestMethod.GET)
	public ModelAndView addBanks(@RequestParam(value = "id", required = false) String id)
			throws ControllerException {
		ModelAndView mav = new ModelAndView("payment/addbanks");
		PMBanks pmbanks = pmbanksService.getBanksList(id);
		if(StringUtil.isNotEmpty(id)){
			mav.addObject("banksid", id);
			mav.addObject("bankCode", pmbanks.getBankCode());
			mav.addObject("bankName", pmbanks.getBankName());
			mav.addObject("bankOrder", pmbanks.getBankOrder());
			mav.addObject("status", pmbanks.getStatus());
			mav.addObject("channelType", pmbanks.getChannelType());
		    mav.addObject("bankLogo", pmbanks.getBankLogo());
		}
		String bankss = pmbanksService.getMaxBankOrder();
		mav.addObject("maxbankOrder", bankss);
		
		return mav;
	}
	
    //银行列表查看	
	@RequestMapping(value = "initbankslist", method = RequestMethod.GET)
	@ResponseBody
	public Map<String,Object> initBanksList(//@RequestParam(required = false) String startdate,@RequestParam(required = false) String enddate,
			@ModelAttribute PagingParams para,@ModelAttribute PMBanks pmbanks)
					throws ControllerException {
		if(pmbanks!=null){
			if(pmbanks.getBankName()!=null&&pmbanks.getBankName().equals("")){
				pmbanks.setBankName(null);
			}
			if(pmbanks.getStatus()!=null&&pmbanks.getStatus().equals("")){
				pmbanks.setStatus(null);
			}
		}
		Map<String, Object> map = BeanUtils.toMap(pmbanks,para);
		return pmbanksService.initBanksList(map);
	}
	
	//保存银行
	@RequestMapping(value = "savebanks", method = RequestMethod.POST)
	@ResponseBody
	public Map<String,Object> saveBanksInfo(@RequestParam(value = "file") MultipartFile file,HttpServletRequest request,
			@ModelAttribute PMBanks pmbanks)throws ControllerException {
		System.out.println(request.getParameter("bank_logo"));
		return pmbanksService.saveOrUpdateBanksInfo(pmbanks,file);
	}
	
	//查看页面点击取消//放弃银行信息保存操作，修改信息初始化
	@RequestMapping(value = "selectbanks", method = RequestMethod.POST)
	@ResponseBody
	public Map<String,Object> selectBanksInfo(@ModelAttribute PagingParams para,@ModelAttribute PMBanks pmbanks)
				throws ControllerException {
		return pmbanksService.selectBanksInfo(pmbanks);
	}
	
	
}
