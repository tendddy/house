package com.cninsure.payment.util;

import payment.api.system.CMBEnvironment;
import payment.api.system.PaymentUserEnvironment;
import payment.api.system.TxMessenger;
import payment.api.tx.TxBaseRequest;

import com.cninsure.payment.model.ZhongJinFormModel;

public class TxCore {

	public static String[] zhongJinMethod(ZhongJinFormModel model,
			TxBaseRequest txbaserequest) {
		// 加密数据

		String[] respMsg = null;
		try {
			// 调用支付平台
			respMsg = sendData2Payplatform(model);
		} catch (Exception e1) {
			e1.printStackTrace();
		}
		return respMsg;
	}


	/**
	 * 接口方法
	 * 
	 * @param T
	 * @param TxCode
	 * @param TxName
	 * @return
	 */
	public static String[] handlerParam(TxBaseRequest baseRequest,String TxCode, String TxName) {
		String[] respMsg = null;
		try {
			// 加密
			baseRequest.process();
//            System.out.println("[plainText]=[" + baseRequest.getRequestPlainText() + "]");
            String message = baseRequest.getRequestMessage();
            String signature = baseRequest.getRequestSignature();
            String flag = null;
            
            // 与支付平台进行通讯
            TxMessenger txMessenger = new TxMessenger();
            // Flag=10:cmb, 20:paymentAccount
            if ("10".equals(flag)){
            	respMsg = txMessenger.send(message, signature, CMBEnvironment.cmbtxURL);// 0:message;
            } else if ("20".equals(flag)){
                respMsg = txMessenger.send(message, signature, PaymentUserEnvironment.paymentusertxURL);
            }else if ("30".equals(flag)){
                respMsg = txMessenger.send(message, signature, PaymentUserEnvironment.paymentusertxURL2);
            }else {
            	respMsg = txMessenger.send(message, signature);// 0:message;
            }
            // 1:signature
            String plainText = new String(payment.tools.util.Base64.decode(respMsg[0]), "UTF-8");

            //System.out.println("[message]=[" + respMsg[0] + "]");
            //System.out.println("[signature]=[" + respMsg[1] + "]");
//            System.out.println("[plainText]=[" + plainText + "]");
		} catch (Exception e1) {
			e1.printStackTrace();
			return null;
		}
		return respMsg;
	}

	/**
	 * 调用中金服务器
	 * 
	 * @param model
	 * @return
	 * @throws Exception
	 */
	public static String[] sendData2Payplatform(ZhongJinFormModel model)throws Exception {
		if (model == null) {
			return null;
		}
		String flag = model.getFlag();
		String message = model.getMessage();
		String signature = model.getSignature();

		// 与支付平台进行通讯
		TxMessenger txMessenger = new TxMessenger();
		String[] respMsg = null;
		if ("10".equals(flag)) {
			respMsg = txMessenger.send(message, signature,
					CMBEnvironment.cmbtxURL);
		} else if ("20".equals(flag)) {
			respMsg = txMessenger.send(message, signature,
					PaymentUserEnvironment.paymentusertxURL);
		} else if ("30".equals(flag)) {
			respMsg = txMessenger.send(message, signature,
					PaymentUserEnvironment.paymentusertxURL2);
		} else {
			respMsg = txMessenger.send(message, signature,
					CMBEnvironment.cmbtxURL);// 0:message;
		}
		return respMsg;
	}
}
