package com.cninsure.payment.timer.job;


import javax.annotation.Resource;

import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.quartz.Scheduler;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import payment.api.tx.realgathering.Tx2020Request;
import payment.api.tx.realgathering.Tx2020Response;

import com.cninsure.payment.dao.PMBankcardDao;
import com.cninsure.payment.dao.PMLogRecordsDao;
import com.cninsure.payment.dao.PMPaymentDao;
import com.cninsure.payment.dao.PMProductsDao;
import com.cninsure.payment.entity.PMProducts;
import com.cninsure.payment.util.TxCore;
import com.cninsure.payment.util.quartzUtil;

/**
 * 单次支付查询 products表操作
 * 
 * 规则：5秒一次轮询90秒 
 * 成功：回写数据库
 * 失败：人工干预 通知管理员处理
 * 
 * 
 */
@Service
public class Tx2020QueryPayResultJob  implements Job    {
	@Resource
	private PMBankcardDao pmBankcardDao;
	@Resource
	private PMProductsDao productsDao;
	@Resource
	private PMPaymentDao pmPaymentDao;
	@Resource
	private PMLogRecordsDao pmLogRecordsDao;
	@Resource
	public  Scheduler sched;
	
	@Value("${tx.institutionID}")
	private String txInstitutionID;
	
	@Override
	public void execute(JobExecutionContext context)throws JobExecutionException {
		System.out.println("2020"+"单笔代收查询");
		// jobName
		String ProInstanceId_Prvcode = context.getJobDetail().getKey().getName();
		String logId = ProInstanceId_Prvcode.split("_")[1];
		String payProtocolId = ProInstanceId_Prvcode.split("_")[2];
		
		Tx2020Request txRequest = new Tx2020Request();
		txRequest.setInstitutionID(txInstitutionID);
		txRequest.setTxSN(payProtocolId);
		
		String[] respMsg = TxCore.handlerParam(txRequest, "2020", "单笔代收查询");
		Tx2020Response zhongjinResponse = null;
		try {
			zhongjinResponse = new Tx2020Response(respMsg[0], respMsg[1]);
		} catch (Exception e) {
			e.printStackTrace();
		}
		System.out.println("2020zhongjinResponse.getCode()"+zhongjinResponse.getCode());
		if ("2000".equals(zhongjinResponse.getCode())) {
			System.out.println("2020zhongjinResponse.getStatus()"+zhongjinResponse.getStatus());
			if (zhongjinResponse.getStatus() == 20) {
				// TODO 超时查询，处理中需要人工干预 暂不处理
			} else if (zhongjinResponse.getStatus() == 30) {
				//接口操作日志状态更新
				pmLogRecordsDao.updateLogStatusById(Long.parseLong(logId));
				PMProducts updateSatusProductModel = new PMProducts();	
				updateSatusProductModel.setPayprotocolid(payProtocolId);
				updateSatusProductModel.setStatementStatus("0");//支付成功
				updateSatusProductModel.setStatus("2");
				productsDao.updateByPayProtocolIdSelective(updateSatusProductModel);
				// 取消开始90秒定时任务
				quartzUtil.deleteHistoryJob(sched, ProInstanceId_Prvcode, "timeout2011");
				quartzUtil.deleteHistoryJob(sched, ProInstanceId_Prvcode, "poll2011");
			} else if (zhongjinResponse.getStatus() == 40) {
				// TODO 超时查询失败，处理中需要人工干预 暂不处理
				PMProducts updateSatusProductModel = new PMProducts();
				updateSatusProductModel.setStatementStatus("1");//支付失败
				updateSatusProductModel.setStatus("3");//支付失败
				productsDao.updateByPayProtocolIdSelective(updateSatusProductModel);
			}
		} else {
		}
	}
}
