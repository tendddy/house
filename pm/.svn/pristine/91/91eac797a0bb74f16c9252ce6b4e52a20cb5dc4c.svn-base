package com.cninsure.payment.service.impl;

import java.math.BigDecimal;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.cninsure.core.dao.BaseDao;
import com.cninsure.core.dao.impl.BaseServiceImpl;
import com.cninsure.core.utils.StringUtil;
import com.cninsure.payment.dao.PMApprateDao;
import com.cninsure.payment.entity.PMApprate;
import com.cninsure.payment.service.PMApprateService;

@Service
@Transactional
public class PMApprateServiceImpl extends BaseServiceImpl<PMApprate,Long> implements
		PMApprateService {
	@Resource
	private PMApprateDao pmApprateDao;

	@Override
	protected BaseDao<PMApprate,Long> getBaseDao() {
		return pmApprateDao;
	}
	
	@Override
	public Map<String, Object> saveOrUpdateRateInfo(
			PMApprate pmapptrate) {
		pmapptrate.setChannelType("01");
		if("1".equals(pmapptrate.getRateType())){//固定金额
			pmapptrate.setRate(pmapptrate.getRate().movePointRight(2));
		}
		pmapptrate.setMinimumAmount(new DecimalFormat("####").format(new BigDecimal(pmapptrate.getMinimumAmount().replace(",", "")).movePointRight(2)));
		pmapptrate.setMaximumAmount(new DecimalFormat("####").format(new BigDecimal(pmapptrate.getMaximumAmount().replace(",", "")).movePointRight(2)));
		if(StringUtil.isEmpty(pmapptrate.getId())){
			pmApprateDao.saveRate(pmapptrate);
		}else{
			pmApprateDao.updateRate(pmapptrate);
		}
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("id", pmapptrate.getId());
		map.put("appId", pmapptrate.getAppId());
		map.put("minimumAmount", new DecimalFormat("#,###").format(new BigDecimal(pmapptrate.getMinimumAmount()).movePointLeft(2)));
		map.put("maximumAmount", new DecimalFormat("#,###").format(new BigDecimal(pmapptrate.getMaximumAmount()).movePointLeft(2)));
		map.put("rateType", pmapptrate.getRateType());
		if("1".equals(pmapptrate.getRateType())){//固定金额
			map.put("rate", new DecimalFormat("###.##").format(pmapptrate.getRate().movePointLeft(2)));
		}else{
			map.put("rate", pmapptrate.getRate());
		}
		return map;
	}

	@Override
	public Map<String, Object> deleteRateInfo(PMApprate pmapptrate) {
		pmApprateDao.deleteRate(pmapptrate);
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("message", "删除成功");
		return map;
	}

	@Override
	public Map<String, Object> selectRateInfo(PMApprate pmapptrate) {
		pmapptrate=pmApprateDao.selectRate(pmapptrate);
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("id", pmapptrate.getId());
		map.put("appId", pmapptrate.getAppId());
		map.put("rateType", pmapptrate.getRateType());
		if("1".equals(pmapptrate.getRateType())){//固定金额
			map.put("rate", new DecimalFormat("###.##").format(pmapptrate.getRate().movePointLeft(2)));
		}else{
			map.put("rate", pmapptrate.getRate());
		}
		map.put("minimumAmount", new DecimalFormat("#,###").format(new BigDecimal(pmapptrate.getMinimumAmount()).movePointLeft(2)));
		map.put("maximumAmount", new DecimalFormat("#,###").format(new BigDecimal(pmapptrate.getMaximumAmount()).movePointLeft(2)));
		return map;
	}

	@Override
	public List<Map<String, Object>> getRateList(String id) {
		return pmApprateDao.selectRateList(id);
	}

	@Override
	public Map<String, Object> selectRateTrackInfo(Map<String, Object> map) {
		Map<String, Object> data = new HashMap<String, Object>();
		long total = pmApprateDao.getRateTrackCount(map);
		List<Map<Object, Object>> infoList = pmApprateDao.selectRateTrackList(map);
		for (int i = 0; i < infoList.size(); i++) {
			Map<Object, Object> map2 = infoList.get(i);
			Object rateType = map2.get("rateType");
			if(rateType!=null&&!"".equals(rateType)){
				if(rateType.equals("0")){
					map2.put("rateType", "百分比");
				}else if(rateType.equals("1")){
					map2.put("rateType", "固定金额");
					double rate = Double.parseDouble( map2.get("rate").toString());
					map2.put("rate",new DecimalFormat("###.##").format(new BigDecimal(rate).movePointLeft(2)));
				}
			}
			Object createdate = map2.get("createdate");
			if(createdate!=null&&!"".equals(createdate)){
				map2.put("createdate", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(createdate));
			}
			int minimumAmount = Integer.parseInt( map2.get("minimumAmount").toString());
			map2.put("minimumAmount",new DecimalFormat("#,###").format(new BigDecimal(minimumAmount).movePointLeft(2)));
			int maximumAmount = Integer.parseInt( map2.get("maximumAmount").toString());
			map2.put("maximumAmount",new DecimalFormat("#,###").format(new BigDecimal(maximumAmount).movePointLeft(2)));
			
		}
		data.put("total", total);
		data.put("rows", infoList);
		return data;
	}
		
}