package com.cninsure.payment.util;

import java.beans.PropertyDescriptor;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.ResourceBundle;

import org.apache.commons.beanutils.PropertyUtilsBean;
import org.apache.http.client.ClientProtocolException;

import com.cninsure.payment.model.BizBindCardModel;
import com.cninsure.payment.model.OrderPayModel;
import com.cninsure.payment.model.QueryOrderPayModel;
import com.cninsure.payment.model.VerifycodeModel;
import com.common.httpClient.HttpProtocolHandler;
import com.common.httpClient.HttpRequest;

/**
 * 调用商联通接口
 * 
 *
 */
public class BizHttpClientUtil {

	private static String BIZ = "";

	static {
		// 读取相关的配置
		ResourceBundle resourceBundle = ResourceBundle.getBundle("config/config");
		BIZ = resourceBundle.getString("biz.url");
	}
	//重要，发生了转码
	public static Map<String, Object> beanToMap(Object obj) {
		Map<String, Object> params = new HashMap<String, Object>(0);
		try {
			PropertyUtilsBean propertyUtilsBean = new PropertyUtilsBean();
			PropertyDescriptor[] descriptors = propertyUtilsBean.getPropertyDescriptors(obj);
			for (int i = 0; i < descriptors.length; i++) {
				String name = descriptors[i].getName();
				if (!"class".equals(name)) {
					if(propertyUtilsBean.getNestedProperty(obj, name)!=null){
						params.put(name,propertyUtilsBean.getNestedProperty(obj, name).toString());
					}
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return params;
	}
	
	
	/**
	 * 调用商联绑定银行卡接口
	 * 
	 * @param cbModel
	 * @throws ClientProtocolException
	 * @throws IOException
	 */
	public static String customBind2BizHttpClient(BizBindCardModel bcModel)throws ClientProtocolException, IOException {
		String path = BIZ+"bankcardVerify.html";
		Map<String, Object> map = new HashMap<String, Object>();
		map = beanToMap(bcModel);
		HttpProtocolHandler hph = HttpProtocolHandler.getInstance();
		return hph.execute(path, map, HttpRequest.METHOD_POST);
	}
	
	
	/**
	 * 获取支付验证码
	 * 
	 * @param cbRmModel
	 * @return
	 * @throws ClientProtocolException
	 * @throws IOException
	 */
	public static String getVerifycodeHttpClient(VerifycodeModel vfModel)throws ClientProtocolException, IOException {
		String path = BIZ+"GetVerifycode.html";
		Map<String, Object> map = new HashMap<String, Object>();
		map = beanToMap(vfModel);
		HttpProtocolHandler hph = HttpProtocolHandler.getInstance();
		return hph.execute(path, map, HttpRequest.METHOD_POST);
	}
	
	
	/**
	 * 订单支付调用商联接口
	 * 
	 * 
	 * @param opModel
	 * @return
	 * @throws ClientProtocolException
	 * @throws IOException
	 */
	public static String orderPayHttpClient(OrderPayModel opModel)throws ClientProtocolException, IOException {
		String path = BIZ+"OrderPay.html";
		Map<String, Object> map = new HashMap<String, Object>();
		map = beanToMap(opModel);
		HttpProtocolHandler hph = HttpProtocolHandler.getInstance();
		return hph.execute(path, map, HttpRequest.METHOD_POST);
	}
	
	/**
	 * 
	 * 订单查询接口 调用商联
	 * 
	 * @param qopModel
	 * @return
	 * @throws ClientProtocolException
	 * @throws IOException
	 */
	public static String queryOrderPayHttpClient(QueryOrderPayModel qopModel)throws ClientProtocolException, IOException {
		String path = "http://demo.shang-lian.com/"+"Query.html";
		Map<String, Object> map = new HashMap<String, Object>();
		map = beanToMap(qopModel);
		HttpProtocolHandler hph = HttpProtocolHandler.getInstance();
		return hph.execute(path, map, HttpRequest.METHOD_POST);
	}


	public static void main(String[] args) throws Exception, IOException {
		BizBindCardModel bbm = new BizBindCardModel();
		bbm.setVersion("v1.0");
		bbm.setCharset("1");
		bbm.setSystemid("1608110001");// TODO
		bbm.setBusinesstype("10000000");
		bbm.setMsgseqno("20160830180502000001");//消息流水号
		bbm.setAccountnumber("5KC0hIdSP6Bn5QUrxC9INRG9J7UYflFG");
		bbm.setAccountname("ttL72Bux/00=");
		bbm.setIdentificationtype("01");
		bbm.setIdentificationnumber("/9rpvZMSy1vzIg0GhLA2Anqv4D0u89Wt");
		bbm.setPhonenumber("roLGyIZK4eXTZ9YR8zap1Q==");
		bbm.setCardtype("10");
		bbm.setValiddate("");
		bbm.setCvn2("");
		bbm.setReceiveurl(""); //TODO 回调后台url
		bbm.setReserved("");
		bbm.setCustominfo("");
		bbm.setFronturl("");
		bbm.setOrderid("");
		bbm.setOrderpayfee("");
		bbm.setSignmsg("Eguw6umh+mIyF1oJMA9877QHnxD0txHcGi46bXofmSbZ+bd3rUx6gjEPt7ebiDAFR9w4KjBR96lyhpGwn9u8sj0hMs3Lcii1Mub5g+Drqi0qECr85H/K0UyAqTf0sPEhkBHcLLxjAnvAXR+a3hLZImjzGQooJpJlOWNJngBOsW4=");
		
		String aa = customBind2BizHttpClient(bbm);
		System.out.println(aa);
	}
}
